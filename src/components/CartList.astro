---

---

<cart-list class="block h-full w-81.5"></cart-list>

<script>
  // @ts-nocheck
  class CartList extends HTMLElement {
    static #template = document.createElement("template");
    static {
      this.#template.innerHTML = /* html */ `
            <style>${this.baseStyles()}</style>
            <div class="component">
                <h2>Your cart(<span>0</span>)</h2>
                <figure>
                  <div>
                    <img src="./assets/images/illustration-empty-cart.svg" alt="Carrito vacio" />
                  </div>
                    <p>Your added items will appear here</p>
                </figure>
                <ul class="list oculto"></ul>
            </div>
            <div class="content-confirm oculto">
              <span>
                <figure>
                  <img src="./assets/images/icon-carbon-neutral.svg"/>
                </figure>
                <p>This is a <b>carbon-neutral</b> delivery</p>   
              </span>
              <button id="btnConfirm">Confirm Order</button>
            </div>
        `;
    }
    static baseStyles() {
      return /* css */ `
            *,
            *::after,
            *::before {
              box-sizing: border-box;
              padding: 0;
              margin: 0;
            }
            .component {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                width: 100%;
                padding: 1rem 1.75rem;
                background-color: white;
                border-radius: 8px;
            }
            h2 {
              color: hsl(14, 86%, 42%);
              margin: 0 0 15px 0;
            }
            figure {
              display: flex;
              flex-direction: column;
              align-items: center;
            }
            figure p {
              font-size: 14px;
              color: hsl(14, 65%, 9%);
            }
            .list li {
              list-style-type: none;
              display: grid;
              grid-template-columns: 1fr auto;
              align-items: center;
              justify-content: space-between;
              margin: 0 0 10px 0;
            }
            .wrapper {
              display: flex;
              flex-wrap: wrap;
              gap: 0 12px;
            }
            .wrapper h3 {
              inline-size: 100%;
              font-size: 15px;
              font-weight: 500;
              color: hsl(14, 65%, 9%);
            }
            .wrapper span {
              color: hsl(14, 86%, 42%);
              font-size: 14px;
              font-weight: 600;
            }
            .wrapper p {
              font-size: 14px;
              color: hsl(12, 20%, 44%);
            }
            .list button {
              &:hover {
                border: solid 1px #260f08;
              }
              &:hover svg path {
                fill: #260f08;
              }
              display: grid;
              place-items: center;
              cursor: pointer;
              border-radius: 50%;
              border: solid 1px hsl(14, 25%, 72%);
              background-color: white;
              padding: 2px;
            }
            .total {
              display: flex;
              justify-content: space-between;
              align-items: center;
              inline-size: 100%;
            }
            .total span {
              font-size: 24px;
              font-weight: 700;
            }
            .total p {
              font-size: 12px;
            }
            hr {
              grid-column: 1/3;
              margin: 5px 0 0 0;
              inline-size: 100%;
              opacity: .5;
            }
            .content-confirm {
              display: flex;
              flex-direction: column;
              gap: 8px;
              padding: 0 25px;
            }
            .content-confirm span {
              display: flex;
              justify-content: center;
              gap: 4px;
              font-size: 12px;
              background-color: hsl(20, 50%, 98%);
              border-radius: 8px;
              padding: 12px;
            }
            #btnConfirm {
              padding: 12px;
              border-style: none;
              border-radius: 20px;
              cursor: pointer;
              font-family: inherit;
              color: hsl(20, 50%, 98%);
              background-color: hsl(14, 86%, 42%);
              &:hover {
                background-color: hsl(159, 69%, 38%);
              }
            }
            img {
              display: block;
              inline-size: 100%;
              block-size: 100%;              
            }
            .oculto {
              display: none;
            }
            
        `;
    }
    constructor() {
      super();
      this.attachShadow({ mode: "open" });
      this.shadowRoot.appendChild(CartList.#template.content.cloneNode(true));
      this.$h2 = this.shadowRoot.querySelector("h2 span");
      this.$list = this.shadowRoot.querySelector("ul");
      this.$figure = this.shadowRoot.querySelector("figure");
      this.$contentConfirm = this.shadowRoot.querySelector(".content-confirm");
      this.$btnConfirm = this.shadowRoot.querySelector("#btnConfirm");
      this.idItems = [];
      this.cantidad = 0;
    }

    connectedCallback() {
      this.$list.addEventListener("click", (e) => this.deleteProduct(e));
      this.$btnConfirm.addEventListener("click", (e) => this.confirmOrder(e));
    }

    render(e) {
      // Cuando las unidades de un producto llegue a cero se eliminan de la lista
      if (e.detail.unidades < 1) {
        const item = this.$list.querySelector(`#${e.detail.dataId}`);
        if (item) {
          item.remove();
          this.idItems = this.idItems.filter(
            (id) => id !== `${e.detail.dataId}`,
          );

          const updataOrder =
            this.shadowRoot.querySelector(".component .total");
          updataOrder.innerHTML = "";
          updataOrder.appendChild(this.orderTotal());

          this.totalUnidades();

          if (this.idItems.length === 0) {
            updataOrder.remove();
            this.$figure.classList.remove("oculto");
            this.$list.classList.add("oculto");
            this.$contentConfirm.classList.add("oculto");
          }
        }
      } else {
        if (!this.idItems.includes(e.detail.dataId)) {
          // Si el producto no esta, lo crea y lo agrega
          const $li = document.createElement("li"),
            $h3 = document.createElement("h3"),
            $p = document.createElement("p"),
            $span = document.createElement("span"),
            $btnDelete = document.createElement("button"),
            $hr = document.createElement("hr"),
            $wrapper = document.createElement("div");

          $h3.textContent = e.detail.nombre;
          $span.textContent = `${e.detail.unidades}x`;
          $p.textContent = `@$${e.detail.precio} - $${e.detail.total}`;
          $wrapper.className = "wrapper";

          $btnDelete.innerHTML =
            '<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="none" viewBox="0 0 10 10"><path fill="#CAAFA7" d="M8.375 9.375 5 6 1.625 9.375l-1-1L4 5 .625 1.625l1-1L5 4 8.375.625l1 1L6 5l3.375 3.375-1 1Z"/></svg>';

          $li.id = e.detail.dataId;
          $li.dataset.unidades = e.detail.unidades;
          $li.dataset.total = e.detail.total;

          $wrapper.appendChild($h3);
          $wrapper.appendChild($span);
          $wrapper.appendChild($p);
          $li.appendChild($wrapper);
          $li.appendChild($btnDelete);
          $li.appendChild($hr);
          this.$list.appendChild($li);
          // Verificamos si el elemento "total" esta
          const updataOrder =
              this.shadowRoot.querySelector(".component .total"),
            $element = document.createElement("div");

          $element.className = "total";
          // console.log($element);
          if (!updataOrder) {
            // en caso de que no este, lo agregamos
            $element.appendChild(this.orderTotal());
            this.shadowRoot.querySelector(".component").appendChild($element);
          } else {
            // en caso de que si este, limpiamos y volvemos a colocar los datos actualizados
            updataOrder.innerHTML = "";
            updataOrder.appendChild(this.orderTotal());
          }

          this.$figure.classList.add("oculto");
          this.$list.classList.remove("oculto");
          this.$contentConfirm.classList.remove("oculto");
          this.idItems.push(e.detail.dataId);
          this.totalUnidades();
        } else {
          // Y si el produto esta, lo busca y lo actualiza
          const $items = this.$list.querySelector(`#${e.detail.dataId}`);
          $items.dataset.unidades = e.detail.unidades;
          $items.dataset.total = e.detail.total;
          $items.querySelector("span").textContent = `${e.detail.unidades}x`;
          $items.querySelector("p").textContent =
            `@$${e.detail.precio} - $${e.detail.total}`;

          const updataOrder =
            this.shadowRoot.querySelector(".component .total");
          updataOrder.innerHTML = "";
          updataOrder.appendChild(this.orderTotal());

          this.totalUnidades();
        }
      }
    }

    totalUnidades() {
      const $item = this.$list.querySelectorAll("li");
      const suma = [];

      $item.forEach((element) => {
        suma.push(parseInt(element.dataset.unidades));
      });
      this.cantidad = suma.reduce((acu, vA) => acu + vA, 0);
      this.$h2.textContent = this.cantidad;
    }

    orderTotal() {
      const $orderTotal = document.createDocumentFragment(),
        $span = document.createElement("span"),
        $p = document.createElement("p");
      const $item = this.$list.querySelectorAll("li"),
        suma = [];

      $item.forEach((element) => {
        suma.push(parseFloat(element.dataset.total));
      });

      $p.textContent = "Order total";
      $span.textContent = `$${suma.reduce((acu, vA) => acu + vA, 0)}`;

      $orderTotal.appendChild($p);
      $orderTotal.appendChild($span);

      return $orderTotal;
    }

    deleteProduct(e) {
      const $product = e.target.closest("li");
      if (e.target.closest("button")) {
        this.idItems = this.idItems.filter((id) => id !== $product.id);
        $product.remove();
        this.totalUnidades();

        const $li = this.$list.querySelectorAll("li");
        if ($li.length === 0) {
          this.$figure.classList.remove("oculto");
          this.$list.classList.add("oculto");
          this.$contentConfirm.classList.add("oculto");

          const $removeElement = this.shadowRoot
            .querySelector(".component .total")
            .remove();
        } else {
          const updataOrder =
            this.shadowRoot.querySelector(".component .total");
          updataOrder.innerHTML = "";
          updataOrder.appendChild(this.orderTotal());
        }
        this.dispatchEvent(
          new CustomEvent("delete-product", {
            detail: {
              idProduct: $product.id,
            },
            bubbles: true,
            composed: true,
          }),
        );
      }
    }

    confirmOrder(e) {
      const $fragment = document.createDocumentFragment(),
        $products = this.$list.cloneNode(true),
        $total = this.shadowRoot
          .querySelector(".component .total")
          .cloneNode(true);

      $fragment.appendChild($products);
      $fragment.appendChild($total);

      this.dispatchEvent(
        new CustomEvent("confirm-order", {
          detail: {
            $fragment,
            bubbles: true,
            composed: true,
          },
        }),
      );
    }
  }
  customElements.define("cart-list", CartList);

  const comCr = document.querySelector("cart-list");
  // console.log(comCr.idItems);
</script>
